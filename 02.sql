-- Enunciado 2


-- DROP TAbles
DROP TABLE TOKEN_ACCESS_LOGS;
DROP TABLE MEDICAL_RECORDS;
DROP TABLE ACCESS_TOKENS;
DROP TABLE DOCTORS;
DROP TABLE PATIENTS;
DROP TABLE ERROR_LOGS;


-- Tabela PATIENTS
CREATE TABLE PATIENTS (
    patient_id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    full_name VARCHAR2(255) NOT NULL,
    email_address VARCHAR2(255) UNIQUE NOT NULL,
    password_hash VARCHAR2(255) NOT NULL,
    date_birth DATE NOT NULL,
    cpf VARCHAR2(11) UNIQUE NOT NULL
);

-- Tabela DOCTORS
CREATE TABLE DOCTORS (
    doctor_id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    full_name VARCHAR2(255) NOT NULL,
    email_address VARCHAR2(255) UNIQUE NOT NULL,
    password_hash VARCHAR2(255) NOT NULL,
    date_birth DATE NOT NULL,
    cpf VARCHAR2(11) UNIQUE NOT NULL,
    crm VARCHAR2(20) UNIQUE NOT NULL,
    specialty VARCHAR2(255) NOT NULL
);

-- Tabela ACCESS_TOKENS
CREATE TABLE ACCESS_TOKENS (
    token_id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    patient_id NUMBER NOT NULL,
    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    expiration_time TIMESTAMP NOT NULL,
    status VARCHAR2(20) CHECK (status IN ('active', 'expired')) NOT NULL,
    FOREIGN KEY (patient_id) REFERENCES PATIENTS(patient_id)
);

-- Tabela MEDICAL_RECORDS
CREATE TABLE MEDICAL_RECORDS (
    record_id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    patient_id NUMBER NOT NULL,
    document_body CLOB NOT NULL,
    creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    FOREIGN KEY (patient_id) REFERENCES PATIENTS(patient_id)
);

-- Tabela TOKEN_ACCESS_LOGS
CREATE TABLE TOKEN_ACCESS_LOGS (
    log_id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    token_id NUMBER NOT NULL,
    doctor_id NUMBER NOT NULL,
    access_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    FOREIGN KEY (token_id) REFERENCES ACCESS_TOKENS(token_id),
    FOREIGN KEY (doctor_id) REFERENCES DOCTORS(doctor_id)
);

-- Tabela ERROR_LOGS
CREATE TABLE ERROR_LOGS (
    log_id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    user_name VARCHAR2(255),
    error_date DATE,
    error_code VARCHAR2(255),
    error_message VARCHAR2(4000)
);
